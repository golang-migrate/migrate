name: CI

on:
  push:
  pull_request:

jobs:
  lint:
    uses: ./components/lint.yaml
  test:
    uses: ./components/test.yaml
  check-coverage:
    needs: [test]
    uses: ./components/check-coverage.yaml
  goreleaser:
    needs: [lint, test]
    # This job only runs when
    # 1. When the previous `lint` and `test` jobs has completed successfully
    # 2. When the repository is not a fork, i.e. it will only run on the official golang-migrate/migrate
    # 3. When the workflow is triggered by a tag with `v` prefix
    if: ${{ success() && github.repository == 'golang-migrate/migrate' && startsWith(github.ref, 'refs/tags/v') }}
    uses: ./components/goreleaser.yaml
